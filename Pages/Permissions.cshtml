@page
@model MyWebApp.Pages.PermissionsModel

<h2>สิทธิการใช้งาน</h2>
<button 
     class="btn btn-success mb-3 float-end" 
     data-bs-toggle="modal" 
     data-bs-target="#addPermModal">
   + เพิ่มสิทธิ์การใช้งาน
</button>

<table class="table table-striped table-bordered text-center">
<colgroup>
    <col style="width:60px" />
    <col />
    <col />
    <col />
    <col />
 </colgroup>
  <thead>
    <tr>
    <th>ลำดับ</th>
    <th>รหัส</th>
    <th>ชื่อสิทธิ์</th>
    <th>คำอธิบาย</th>
    <th>จัดการข้อมูล</th></tr>
  </thead>

  <tbody>
    @{ int idx = 1; }
    @foreach(var p in Model.Permissions)
    {
      <tr>
        <td>@idx</td>
        <td>@p.PermissionId</td>
        <td>@p.PermissionName</td>
        <td>@p.Description</td>
        <td>
        <button 
            type="button" 
            class="btn btn-sm btn-warning me-1"
            data-bs-toggle="modal" 
            data-bs-target="#editPermModal"
            onclick="fillEditPermModal('@p.PermissionId','@p.PermissionName','@p.Description')">
        แก้ไข
        </button>
        <button type="button" 
            class="btn btn-sm btn-danger" 
            onclick="showDeletePermModal('@p.PermissionId','@p.PermissionName')">ลบ</button>
        </td>
      </tr>
      idx++;
    }
  </tbody>
</table>

<!-- Modal เพิ่มสิทธิ์ -->
<div class="modal fade" id="addPermModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="post" asp-page-handler="Create" id="createForm" accept-charset="UTF-8" asp-antiforgery="true">
        <div class="modal-header">
          <h5 class="modal-title">เพิ่มสิทธิ์การใช้งาน</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div asp-validation-summary="ModelOnly" class="text-danger mb-2"></div>

       <div class="mb-3">
  <label asp-for="NewPermission.ApplicationId" class="form-label"></label>
  <select asp-for="NewPermission.ApplicationId" class="form-select">
    <option value="">-- กรุณาเลือกแอปพลิเคชัน --</option>
    @foreach (var app in (ViewData["ApplicationList"] as List<MyWebApp.Models.Application>) ?? new())
    {
        <option value="@app.ApplicationId">@app.ApplicationName (@app.ApplicationId)</option> <!-- ✅ ApplicationId อยู่ใน value เท่านั้น -->

    }
  </select>
  <span asp-validation-for="NewPermission.ApplicationId" class="text-danger d-block"></span>
</div>

          <div class="mb-3">
            <label asp-for="NewPermission.PermissionName" class="form-label"></label>
            <input asp-for="NewPermission.PermissionName" class="form-control" />
            <span asp-validation-for="NewPermission.PermissionName" class="text-danger d-block"></span>
          </div>

          <div class="mb-3">
            <label asp-for="NewPermission.Description" class="form-label"></label>
            <textarea asp-for="NewPermission.Description" name="NewPermission.Description" class="form-control"></textarea>
            <span asp-validation-for="NewPermission.Description" class="text-danger d-block"></span>
          </div>
        </div>
        <div class="modal-footer">
         <button type="submit" class="btn btn-success">บันทึก</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal แก้ไขสิทธิ์ -->
<div class="modal fade" id="editPermModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="post" asp-page-handler="Edit">
        <div class="modal-header">
          <h5 class="modal-title">แก้ไขสิทธิ์</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" asp-for="EditPermission.PermissionId" />
          <div class="mb-3">
            <label asp-for="EditPermission.PermissionName" class="form-label"></label>
            <input asp-for="EditPermission.PermissionName" class="form-control" />
            <span asp-validation-for="EditPermission.PermissionName" class="text-danger d-block"></span>
          </div>
          <div class="mb-3">
            <label asp-for="EditPermission.Description" class="form-label"></label>
            <textarea asp-for="EditPermission.Description" class="form-control"></textarea>
            <span asp-validation-for="EditPermission.Description" class="text-danger d-block"></span>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">บันทึก</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
        </div>
      </form>
    </div>
  </div>
</div>


<!-- Confirm Delete Modal -->
<div class="modal fade" id="deletePermModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">ยืนยันการลบ</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>คุณแน่ใจหรือไม่ว่าต้องการลบ: <strong id="deletePermName"></strong>?</p>
      </div>
      <div class="modal-footer">
        <form id="deletePermForm" method="post" asp-page-handler="Delete">
          <input type="hidden" id="deletePermId" name="DeleteId" />
          <button type="submit" class="btn btn-danger">ลบ</button>
        </form>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
      </div>
    </div>
  </div>
</div>


@section Scripts {
  <partial name="_ValidationScriptsPartial" />

  <script>
    function fillEditPermModal(id, name, desc) {
      document.querySelector('#editPermModal input[name="EditPermission.PermissionId"]').value = id;
      document.querySelector('#editPermModal input[name="EditPermission.PermissionName"]').value = name;
      document.querySelector('#editPermModal textarea[name="EditPermission.Description"]').value = desc;

      const modal = new bootstrap.Modal(document.getElementById('editPermModal'));
      modal.show(); // ✅ เปิด modal edit ด้วย API ที่ถูกต้อง
    }

    function showDeletePermModal(id, name) {
      document.getElementById('deletePermName').textContent = name;
      document.getElementById('deletePermId').value = id;

      const modal = new bootstrap.Modal(document.getElementById('deletePermModal'));
      modal.show(); // ✅ เปิด modal delete ด้วย API ที่ถูกต้อง
    }

    // ✅ แสดง addPermModal ถ้ามี error
    @if ((bool?)ViewData["ShowAddModal"] == true) {
      <text>
        document.addEventListener('DOMContentLoaded', function () {
          const modal = new bootstrap.Modal(document.getElementById('addPermModal'));
          modal.show();
        });
      </text>
    }

    // ✅ แสดง editPermModal ถ้ามี error
    @if ((bool?)ViewData["ShowEditModal"] == true) {
      <text>
        document.addEventListener('DOMContentLoaded', function () {
          const modal = new bootstrap.Modal(document.getElementById('editPermModal'));
          modal.show();
        });
      </text>
    }
  </script>
}


